<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Game Time for Grown Ups</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      background: #003a78;
      color: white;
    }
    h1 {
      text-align: center;
      font-size: 1.6rem;
      margin-bottom: 0.3em;
    }
    .logo {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 180px;
    }
    label {
      display: inline-block;
      margin-right: 10px;
    }
    .user-select {
      margin-bottom: 20px;
      font-weight: bold;
      background-color: #0b64bf;
      padding: 8px 12px;
      border-radius: 6px;
    }
    select {
      background-color: #0b64bf;
      color: white;
      border: none;
      padding: 6px 10px;
      font-weight: bold;
      border-radius: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background-color: #0b64bf;
      border-radius: 6px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #003a78;
      padding: 6px;
      text-align: center;
      font-size: 0.9rem;
    }
    th {
      background: #0f7eea;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    #saveBtn {
      background-color: #4CAF50;
    }
    #resetBtn {
      background-color: #d9534f;
    }
    #status {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
    }
    #combinedSection {
      display: none;
    }
    .locked-in {
      background-color: gold !important;
    }
    .all-available {
      background-color: green !important;
      color: white;
    }
    .tick {
      color: white;
    }
    #chatBox {
      margin-top: 30px;
    }
    #chatMessages {
      background-color: #0b64bf;
      padding: 10px;
      height: 120px;
      overflow-y: auto;
      margin-bottom: 10px;
      border-radius: 6px;
    }
    #chatInput {
      width: calc(100% - 90px);
      padding: 8px;
      border: none;
      border-radius: 4px;
      margin-right: 10px;
    }
    #sendBtn {
      width: 70px;
      padding: 8px;
      background-color: #4CAF50;
      border: none;
      color: white;
      border-radius: 4px;
    }
    .day-slot {
      font-size: 0.8rem;
    }
  </style>
</head>
<body>

<img class="logo" src="https://www.highsnobiety.com/static-assets/dato/1682552232-playstation-5-release-date-info-00.jpg" />
<h1>Game Time for Grown Ups</h1>

<div class="user-select">
  Select your name:
  <select id="userSelect">
    <option value="Rhys">Rhys</option>
    <option value="Kris">Kris</option>
    <option value="Matty">Matty</option>
    <option value="Granty">Granty</option>
  </select>
</div>

<form id="availabilityForm">
  <table>
    <thead>
      <tr>
        <th>Day</th>
        <th>Afternoon</th>
        <th>Evening</th>
      </tr>
    </thead>
    <tbody id="formBody"></tbody>
  </table>
  <button id="saveBtn" type="submit">Save Availability</button>
</form>

<div id="status"></div>

<div id="combinedSection">
  <h2>Combined Availability</h2>
  <div id="combinedResults"></div>
  <button id="resetBtn" type="button">Reset Week</button>
</div>

<div id="chatBox">
  <h2>Group Chat</h2>
  <div id="chatMessages"></div>
  <input type="text" id="chatInput" placeholder="Enter message" />
  <button id="sendBtn">Send</button>
</div>

<canvas id="confetti-canvas" style="position: fixed; pointer-events: none; top: 0; left: 0; width: 100%; height: 100%;"></canvas>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD8Za1qEgeVqQY-ZPoAVxbQxNk2gIX_2ic",
  authDomain: "game-time-for-grown-ups.firebaseapp.com",
  databaseURL: "https://game-time-for-grown-ups-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "game-time-for-grown-ups",
  storageBucket: "game-time-for-grown-ups.firebasestorage.app",
  messagingSenderId: "240776591169",
  appId: "1:240776591169:web:ecd7125da1acf789ed93c0",
  measurementId: "G-XFKFZT1FMG"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const users = ["Rhys", "Kris", "Matty", "Granty"];
const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
const slots = ["Afternoon", "Evening"];

const formBody = document.getElementById("formBody");
const userSelect = document.getElementById("userSelect");
const availabilityForm = document.getElementById("availabilityForm");
const statusDiv = document.getElementById("status");
const combinedResults = document.getElementById("combinedResults");
const resetBtn = document.getElementById("resetBtn");
const combinedSection = document.getElementById("combinedSection");
const chatMessages = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");

function buildForm() {
  formBody.innerHTML = "";
  for (const day of days) {
    const tr = document.createElement("tr");
    const dayTd = document.createElement("td");
    dayTd.textContent = day;
    tr.appendChild(dayTd);
    for (const slot of slots) {
      const td = document.createElement("td");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.name = `${day}_${slot}`;
      td.appendChild(checkbox);
      tr.appendChild(td);
    }
    formBody.appendChild(tr);
  }
}

function loadUserData(user) {
  db.ref(`availability/${user}`).once("value").then(snapshot => {
    const data = snapshot.val() || {};
    for (const day of days) {
      for (const slot of slots) {
        const checkbox = availabilityForm.elements[`${day}_${slot}`];
        checkbox.checked = !!data[`${day}_${slot}`];
      }
    }
  });
}

availabilityForm.addEventListener("submit", e => {
  e.preventDefault();
  const user = userSelect.value;
  const userData = {};
  for (const day of days) {
    for (const slot of slots) {
      const checkbox = availabilityForm.elements[`${day}_${slot}`];
      userData[`${day}_${slot}`] = checkbox.checked;
    }
  }
  db.ref(`availability/${user}`).set(userData)
    .then(() => statusDiv.textContent = "Availability saved!");
});

function showCombinedData(allData) {
  if (!allData || Object.keys(allData).length === 0) {
    combinedSection.style.display = "none";
    return;
  }

  combinedSection.style.display = "block";
  const table = document.createElement("table");
  const thead = document.createElement("thead");
  const headerRow = document.createElement("tr");
  headerRow.innerHTML = `<th></th>${users.map(u => `<th>${u}</th>`).join("")}<th>#</th><th></th>`;
  thead.appendChild(headerRow);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");

  for (const day of days) {
    for (const slot of slots) {
      const tr = document.createElement("tr");
      const key = `${day}_${slot}`;
      const labelTd = document.createElement("td");
      labelTd.className = "day-slot";
      labelTd.textContent = `${day} ${slot}`;
      tr.appendChild(labelTd);

      let count = 0;
      for (const user of users) {
        const td = document.createElement("td");
        const available = allData[user]?.[key];
        if (available) {
          td.innerHTML = '<span class="tick">✔️</span>';
          count++;
        }
        tr.appendChild(td);
      }

      const countTd = document.createElement("td");
      countTd.textContent = count;
      tr.appendChild(countTd);

      const lockTd = document.createElement("td");
      const lockBtn = document.createElement("button");
      lockBtn.textContent = "Lock in?";
      lockBtn.style.padding = "6px";
      lockBtn.onclick = () => {
        db.ref(`locked/${key}`).set(true);
        triggerConfetti();
        alert("Let’s fucking go!");
      };
      lockTd.appendChild(lockBtn);
      tr.appendChild(lockTd);

      if (count === 4) tr.classList.add("all-available");

      db.ref(`locked/${key}`).once("value", snap => {
        if (snap.val()) tr.classList.add("locked-in");
      });

      tbody.appendChild(tr);
    }
  }

  table.appendChild(tbody);
  combinedResults.innerHTML = "";
  combinedResults.appendChild(table);
}

db.ref("availability").on("value", snapshot => {
  showCombinedData(snapshot.val());
});

userSelect.addEventListener("change", () => {
  loadUserData(userSelect.value);
  statusDiv.textContent = "";
});

resetBtn.addEventListener("click", () => {
  if (confirm("Are you sure you want to reset everything for the week?")) {
    users.forEach(user => db.ref(`availability/${user}`).remove());
    db.ref("locked").remove();
    db.ref("chat").remove();
    chatMessages.innerHTML = "";
    statusDiv.textContent = "All availability and chat has been reset.";
    buildForm();
  }
});

// Chat
sendBtn.addEventListener("click", () => {
  const user = userSelect.value;
  const msg = chatInput.value.trim();
  if (!msg) return;
  const time = Date.now();
  db.ref(`chat/${time}`).set({ user, msg });
  chatInput.value = "";
});

db.ref("chat").on("value", snapshot => {
  const data = snapshot.val();
  chatMessages.innerHTML = "";
  if (data) {
    Object.values(data).forEach(({ user, msg }) => {
      const p = document.createElement("p");
      p.innerHTML = `<strong>${user}:</strong> ${msg}`;
      chatMessages.appendChild(p);
    });
  }
});

function triggerConfetti() {
  confetti({
    particleCount: 100,
    spread: 100,
    origin: { y: 0.6 },
  });
}

buildForm();
loadUserData(userSelect.value);
</script>

</body>
</html>
