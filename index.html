<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Game Time for Grown Ups</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      background: #003a78;
      color: white;
    }
    h1 {
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 0.3em;
    }
    .logo {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 180px;
    }
    label {
      display: inline-block;
      margin-right: 10px;
    }
    .user-select {
      margin-bottom: 20px;
      font-weight: bold;
      background-color: #0b64bf;
      padding: 8px 12px;
      border-radius: 6px;
    }
    select {
      background-color: #0b64bf;
      color: white;
      border: none;
      padding: 6px 10px;
      font-weight: bold;
      border-radius: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background-color: #0b64bf;
      border-radius: 6px;
      overflow: hidden;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #003a78;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #0f7eea;
    }
    .tick {
      color: white;
      font-size: 1.2rem;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    #saveBtn {
      background-color: #4CAF50;
    }
    #resetBtn {
      background-color: #d9534f;
    }
    #status {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
    }
    .lockBtn {
      background-color: gold;
      color: black;
      font-weight: bold;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .locked {
      background-color: gold !important;
      color: black;
    }
    #combinedResults table {
      font-size: 0.85rem;
    }
    .confetti-msg {
      text-align: center;
      font-weight: bold;
      font-size: 1.2rem;
      color: gold;
      animation: fade 2s ease-out;
    }
    @keyframes fade {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  </style>
</head>
<body>

<img src="https://www.highsnobiety.com/static-assets/dato/1682552232-playstation-5-release-date-info-00.jpg" class="logo" />

<h1>Game Time for Grown Ups</h1>
  
<div class="user-select" aria-label="Select your name">
  Select your name:
  <select id="userSelect" aria-label="User name select">
    <option value="Rhys">Rhys</option>
    <option value="Kris">Kris</option>
    <option value="Matty">Matty</option>
    <option value="Granty">Granty</option>
  </select>
</div>

<form id="availabilityForm">
  <table>
    <thead>
      <tr>
        <th>Day</th>
        <th>Afternoon</th>
        <th>Evening</th>
      </tr>
    </thead>
    <tbody id="formBody"></tbody>
  </table>

  <button id="saveBtn" type="submit">Save Availability</button>
</form>

<div id="status"></div>

<h2>Combined Availability</h2>
<div id="combinedResults"></div>

<button id="resetBtn" type="button">Reset Week</button>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Confetti animation -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD8Za1qEgeVqQY-ZPoAVxbQxNk2gIX_2ic",
    authDomain: "game-time-for-grown-ups.firebaseapp.com",
    databaseURL: "https://game-time-for-grown-ups-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "game-time-for-grown-ups",
    storageBucket: "game-time-for-grown-ups.firebasestorage.app",
    messagingSenderId: "240776591169",
    appId: "1:240776591169:web:ecd7125da1acf789ed93c0"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const users = ["Rhys", "Kris", "Matty", "Granty"];
  const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
  const slots = ["Afternoon", "Evening"];

  const formBody = document.getElementById("formBody");
  const userSelect = document.getElementById("userSelect");
  const availabilityForm = document.getElementById("availabilityForm");
  const statusDiv = document.getElementById("status");
  const combinedResults = document.getElementById("combinedResults");
  const resetBtn = document.getElementById("resetBtn");

  function buildForm() {
    formBody.innerHTML = "";
    for (const day of days) {
      const tr = document.createElement("tr");
      const dayTd = document.createElement("td");
      dayTd.textContent = day;
      tr.appendChild(dayTd);

      for (const slot of slots) {
        const td = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.name = `${day}_${slot}`;
        td.appendChild(checkbox);
        tr.appendChild(td);
      }

      formBody.appendChild(tr);
    }
  }

  function loadUserData(user) {
    db.ref(`availability/${user}`).once("value").then(snapshot => {
      const data = snapshot.val() || {};
      for (const day of days) {
        for (const slot of slots) {
          const checkbox = availabilityForm.elements[`${day}_${slot}`];
          checkbox.checked = !!data[`${day}_${slot}`];
        }
      }
    });
  }

  availabilityForm.addEventListener("submit", e => {
    e.preventDefault();
    const user = userSelect.value;
    const userData = {};
    for (const day of days) {
      for (const slot of slots) {
        const checkbox = availabilityForm.elements[`${day}_${slot}`];
        userData[`${day}_${slot}`] = checkbox.checked;
      }
    }
    db.ref(`availability/${user}`).set(userData)
      .then(() => {
        statusDiv.textContent = "Availability saved!";
      })
      .catch(err => {
        statusDiv.textContent = "Error saving data: " + err;
      });
  });

  function showCombinedData(allData, lockedData) {
    if (!allData) {
      combinedResults.innerHTML = "";
      return;
    }

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");

    headerRow.appendChild(document.createElement("th")); // day+slot
    for (const user of users) {
      const th = document.createElement("th");
      th.textContent = user;
      headerRow.appendChild(th);
    }
    const lockHeader = document.createElement("th");
    lockHeader.textContent = "Lock In";
    headerRow.appendChild(lockHeader);
    const countHeader = document.createElement("th");
    countHeader.textContent = "Count";
    headerRow.appendChild(countHeader);

    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    for (const day of days) {
      for (const slot of slots) {
        const tr = document.createElement("tr");
        const key = `${day}_${slot}`;
        const isLocked = lockedData && lockedData[key];

        const labelTd = document.createElement("td");
        labelTd.textContent = `${day} ${slot}`;
        labelTd.style.fontSize = "0.8rem";
        tr.appendChild(labelTd);

        let count = 0;

        for (const user of users) {
          const td = document.createElement("td");
          const available = allData[user] && allData[user][key];
          if (available) {
            td.innerHTML = '<span class="tick">✔️</span>';
            count++;
          }
          tr.appendChild(td);
        }

        const lockTd = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = "Lock In";
        btn.className = "lockBtn";
        btn.onclick = () => lockRow(key);
        lockTd.appendChild(btn);
        tr.appendChild(lockTd);

        const countTd = document.createElement("td");
        countTd.textContent = count;
        if (count === 4) tr.style.backgroundColor = "#2ecc71";
        tr.appendChild(countTd);

        if (isLocked) {
          tr.classList.add("locked");
        }

        tr.setAttribute("data-key", key);
        tbody.appendChild(tr);
      }
    }

    table.appendChild(tbody);
    combinedResults.innerHTML = "";
    combinedResults.appendChild(table);
  }

  function lockRow(key) {
    db.ref(`locked/${key}`).set(true).then(() => {
      const msg = document.createElement("div");
      msg.className = "confetti-msg";
      msg.textContent = "Let's f***ing go!";
      combinedResults.prepend(msg);
      confetti();
    });
  }

  db.ref().on("value", snapshot => {
    const data = snapshot.val() || {};
    showCombinedData(data.availability, data.locked);
  });

  userSelect.addEventListener("change", () => {
    loadUserData(userSelect.value);
    statusDiv.textContent = "";
  });

  resetBtn.addEventListener("click", () => {
    if (confirm("Are you sure you want to reset all availability and lock-ins for the week?")) {
      users.forEach(user => {
        db.ref(`availability/${user}`).remove();
      });
      db.ref(`locked`).remove();
      statusDiv.textContent = "All availability and lock-ins have been reset.";
      buildForm();
    }
  });

  buildForm();
  loadUserData(userSelect.value);
</script>

</body>
</html>
