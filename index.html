<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Game Time for Grown Ups</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      background: #003a78;
      color: white;
    }
    h1 {
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 0.3em;
    }
    .logo {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 180px;
    }
    label {
      display: inline-block;
      margin-right: 10px;
    }
    .user-select {
      margin-bottom: 20px;
      font-weight: bold;
      background-color: #0b64bf;
      padding: 8px 12px;
      border-radius: 6px;
    }
    select {
      background-color: #0b64bf;
      color: white;
      border: none;
      padding: 6px 10px;
      font-weight: bold;
      border-radius: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background-color: #0b64bf;
      border-radius: 6px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #003a78;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #0f7eea;
    }
    .day-col {
      font-size: 0.85rem;
      width: 90px;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    #saveBtn {
      background-color: #4CAF50;
    }
    #resetBtn {
      background-color: #d9534f;
    }
    #status {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
    }
    #combinedResults table {
      background-color: #0b64bf;
      color: white;
      font-size: 0.9rem;
    }
    .locked-in {
      background-color: gold !important;
    }
    .green-message {
      color: #7CFC00;
    }
    #chatContainer {
      background-color: #0b64bf;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    #messages {
      max-height: 150px;
      overflow-y: auto;
      margin-bottom: 10px;
      background-color: #003a78;
      padding: 10px;
      border-radius: 6px;
    }
    #messages div {
      margin-bottom: 5px;
    }
    #chatInput {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 5px;
    }
  </style>
</head>
<body>

<img class="logo" src="https://www.highsnobiety.com/static-assets/dato/1682552232-playstation-5-release-date-info-00.jpg" alt="PS5 Logo" />

<h1>Game Time for Grown Ups</h1>

<div class="user-select" aria-label="Select your name">
  Select your name:
  <select id="userSelect" aria-label="User name select">
    <option value="Rhys">Rhys</option>
    <option value="Kris">Kris</option>
    <option value="Matty">Matty</option>
    <option value="Granty">Granty</option>
  </select>
</div>

<form id="availabilityForm">
  <table>
    <thead>
      <tr>
        <th>Day</th>
        <th>Afternoon</th>
        <th>Evening</th>
      </tr>
    </thead>
    <tbody id="formBody"></tbody>
  </table>
  <button id="saveBtn" type="submit">Save Availability</button>
</form>

<div id="status"></div>

<div id="combinedContainer" style="display: none;">
  <h2>Combined Availability</h2>
  <div id="combinedResults"></div>
  <button id="resetBtn" type="button">Reset Week</button>
</div>

<!-- Chat -->
<div id="chatContainer">
  <h2>Group Chat</h2>
  <div id="messages"></div>
  <input type="text" id="chatInput" placeholder="Enter message and press Enter" />
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD8Za1qEgeVqQY-ZPoAVxbQxNk2gIX_2ic",
    authDomain: "game-time-for-grown-ups.firebaseapp.com",
    databaseURL: "https://game-time-for-grown-ups-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "game-time-for-grown-ups",
    storageBucket: "game-time-for-grown-ups.firebasestorage.app",
    messagingSenderId: "240776591169",
    appId: "1:240776591169:web:ecd7125da1acf789ed93c0",
    measurementId: "G-XFKFZT1FMG"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const users = ["Rhys", "Kris", "Matty", "Granty"];
  const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
  const slots = ["Afternoon", "Evening"];

  const formBody = document.getElementById("formBody");
  const userSelect = document.getElementById("userSelect");
  const availabilityForm = document.getElementById("availabilityForm");
  const statusDiv = document.getElementById("status");
  const combinedResults = document.getElementById("combinedResults");
  const resetBtn = document.getElementById("resetBtn");
  const combinedContainer = document.getElementById("combinedContainer");

  function buildForm() {
    formBody.innerHTML = "";
    for (const day of days) {
      const tr = document.createElement("tr");
      const dayTd = document.createElement("td");
      dayTd.textContent = day;
      tr.appendChild(dayTd);
      for (const slot of slots) {
        const td = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.name = `${day}_${slot}`;
        td.appendChild(checkbox);
        tr.appendChild(td);
      }
      formBody.appendChild(tr);
    }
  }

  function loadUserData(user) {
    db.ref(`availability/${user}`).once("value").then(snapshot => {
      const data = snapshot.val() || {};
      for (const day of days) {
        for (const slot of slots) {
          const checkbox = availabilityForm.elements[`${day}_${slot}`];
          checkbox.checked = !!data[`${day}_${slot}`];
        }
      }
    });
  }

  availabilityForm.addEventListener("submit", e => {
    e.preventDefault();
    const user = userSelect.value;
    const userData = {};
    for (const day of days) {
      for (const slot of slots) {
        const checkbox = availabilityForm.elements[`${day}_${slot}`];
        userData[`${day}_${slot}`] = checkbox.checked;
      }
    }
    db.ref(`availability/${user}`).set(userData).then(() => {
      statusDiv.textContent = "Availability saved!";
    });
  });

  function showCombinedData(allData) {
    combinedResults.innerHTML = "";

    if (!allData) {
      combinedContainer.style.display = "none";
      return;
    }

    combinedContainer.style.display = "block";
    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");

    const thDay = document.createElement("th");
    thDay.textContent = "Day/Slot";
    thDay.className = "day-col";
    headerRow.appendChild(thDay);

    for (const user of users) {
      const th = document.createElement("th");
      th.textContent = user;
      headerRow.appendChild(th);
    }

    const thCount = document.createElement("th");
    thCount.textContent = "Available";
    headerRow.appendChild(thCount);

    const thLock = document.createElement("th");
    thLock.textContent = "";
    headerRow.appendChild(thLock);

    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    for (const day of days) {
      for (const slot of slots) {
        const rowKey = `${day}_${slot}`;
        const tr = document.createElement("tr");
        tr.setAttribute("data-key", rowKey);

        const tdDaySlot = document.createElement("td");
        tdDaySlot.textContent = `${day} ${slot}`;
        tdDaySlot.className = "day-col";
        tr.appendChild(tdDaySlot);

        let availableCount = 0;
        for (const user of users) {
          const td = document.createElement("td");
          const available = allData[user] && allData[user][rowKey];
          if (available) {
            td.innerHTML = "✔️";
            availableCount++;
          } else {
            td.textContent = "";
          }
          tr.appendChild(td);
        }

        const countTd = document.createElement("td");
        countTd.textContent = availableCount;
        if (availableCount === 4) tr.style.backgroundColor = "#228B22";
        tr.appendChild(countTd);

        const lockTd = document.createElement("td");
        const lockBtn = document.createElement("button");
        lockBtn.textContent = "Lock in?";
        lockBtn.style.width = "100%";
        lockBtn.onclick = () => {
          const ref = db.ref(`lockins/${rowKey}`);
          ref.once("value").then(snapshot => {
            if (snapshot.val()) {
              ref.remove();
              statusDiv.textContent = "";
            } else {
              ref.set(true);
              statusDiv.innerHTML = `<span class="green-message">Let’s f***ing go!</span>`;
            }
          });
        };
        lockTd.appendChild(lockBtn);
        tr.appendChild(lockTd);

        tbody.appendChild(tr);
      }
    }

    table.appendChild(tbody);
    combinedResults.appendChild(table);

    db.ref("lockins").once("value").then(snapshot => {
      const lockedRows = snapshot.val() || {};
      for (const key in lockedRows) {
        const row = document.querySelector(`tr[data-key="${key}"]`);
        if (row) row.classList.add("locked-in");
      }
    });
  }

  db.ref("availability").on("value", snapshot => {
    showCombinedData(snapshot.val());
  });

  userSelect.addEventListener("change", () => {
    loadUserData(userSelect.value);
    statusDiv.textContent = "";
  });

  resetBtn.addEventListener("click", () => {
    if (confirm("Are you sure you want to reset everything?")) {
      users.forEach(user => db.ref(`availability/${user}`).remove());
      db.ref("chat").remove();
      db.ref("lockins").remove();
      statusDiv.textContent = "All availability and chat has been reset.";
      buildForm();
      document.getElementById("messages").innerHTML = "";
    }
  });

  // Chat
  const messagesDiv = document.getElementById("messages");
  const chatInput = document.getElementById("chatInput");

  chatInput.addEventListener("keypress", e => {
    if (e.key === "Enter" && chatInput.value.trim()) {
      const msg = chatInput.value.trim();
      const name = userSelect.value;
      db.ref("chat").push({ name, msg });
      chatInput.value = "";
    }
  });

  db.ref("chat").on("child_added", snapshot => {
    const { name, msg } = snapshot.val();
    const div = document.createElement("div");
    div.textContent = `${name}: ${msg}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  buildForm();
  loadUserData(userSelect.value);
</script>

</body>
</html>
